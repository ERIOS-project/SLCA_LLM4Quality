import os
import json
from dotenv import load_dotenv
from consistency_llm.utils import get_filenames_from_pattern, get_id_from_filename, init_folder

# Load environment variables from a .env file
load_dotenv()

class ScaEvaluation:
    """
    A class to handle the evaluation of outputs generated by a language model (LLM) 
    by comparing results from two different runs (output_1 and output_2).
    """

    def __init__(self, output_directory):
        """
        Initializes the ScaEvaluation class by creating necessary output directories
        based on the model name from environment variables.
        """
        self.__output_directory = output_directory
        init_folder("./" + output_directory + "/")
        init_folder("./" + output_directory + "/evaluations/")    
        init_folder("./" + output_directory + "/evaluations/sca")    

    def run(self):
        """
        Executes the evaluation process by comparing outputs from two runs (output_1 and output_2).
        The evaluation results are saved to the appropriate directory.
        """
        print("SCA Evaluation")
        filenames = get_filenames_from_pattern("./" + self.__output_directory + "/llm_queries/output_1/", "initial_classification_result_")
        for filename in filenames:
            id = get_id_from_filename(filename)
            print(f"- Input {id}")
            with open("./" + self.__output_directory + "/llm_queries/output_1/" + filename, 'r') as file:
                output_1 = json.load(file)
            with open("./" + self.__output_directory + "/llm_queries/output_2/" + filename, 'r') as file:
                output_2 = json.load(file)
            evaluation = self.__evaluate(output_1["output"], output_2["output"])
            self.__save_evaluation(id, {
                "input": [output_1["input"], output_2["input"]],
                "output": evaluation
            })

    def __evaluate(self, output_1, output_2):
        """
        Compares two outputs recursively and generates an evaluation result.

        :param output_1: The first output (dictionary) to be compared.
        :param output_2: The second output (dictionary) to be compared.
        :return: A string containing the evaluation result in JSON format.
        """

        def recursive_compare_and_generate(cat1, cat2):
            """
            Recursively compares categories and subcategories between two outputs.

            :param cat1: The first category dictionary to compare.
            :param cat2: The second category dictionary to compare.
            :return: A dictionary with the comparison results.
            """
            result = {}
            for subcat_name, subcat1 in cat1.items():
                subcat2 = cat2.get(subcat_name)
                if isinstance(subcat1, dict) and isinstance(subcat2, dict):
                    if "positive" in subcat1:  # Terminal category containing the specific keys
                        result[subcat_name] = {
                            key: 1 if self.__check_value(subcat1.get(key)) and self.__check_value(subcat2.get(key)) else 0
                            for key in ["positive", "negative"]
                        }
                    else:
                        result[subcat_name] = recursive_compare_and_generate(subcat1, subcat2)
                else:
                    result[subcat_name] = 1 if subcat1 == subcat2 else 0
            return result

        return recursive_compare_and_generate(output_1, output_2)
    
    def __save_evaluation(self, id, evaluation):
        """
        Saves the evaluation result to a JSON file.

        :param id: The ID associated with the input being evaluated.
        :param evaluation: A string containing the evaluation result in JSON format.
        :return: None.
        """
        file_path = f"./{self.__output_directory}/evaluations/sca/result_{id}.json"
        with open(file_path, "w", encoding="utf-8") as file:
            file.write(json.dumps(evaluation, ensure_ascii=False, indent=4))

    def __check_value(self, s):
        """
        Checks if a given string meets specific criteria.

        :param s: The string to be checked.
        :return: True if the string contains a '|' character and its length is at least 4, False otherwise.
        """
        if '|' in s and len(s) >= 4:
            return True
        else:
            return False
